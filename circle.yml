machine:
  services:
    - docker

dependencies:
  override:
    - docker info
    - docker version
    - docker build --rm=false -t circleci/shellcheck .

test:
  override:
    - docker run -it -v $(pwd)/dist:/data circleci/shellcheck -c "shellcheck -e 2086 -e SC2046 manager"
    - docker run -it -v $(pwd)/lib:/data circleci/shellcheck -c "shellcheck -e 2086 -e SC2046 -e SC2034 *"
    - docker run -it -v $(pwd)/lib:/data circleci/shellcheck -c "shellcheck -e SC2034 *" || true

compile:
  override:
    - docker run -it -v $(pwd):/data circleci/shellcheck -c "./selfextractor_build.sh"
    - cp -r dist ${CIRCLE_ARTIFACTS}/
    - export VERSION="$(cat VERSION)" && cd ${CIRCLE_ARTIFACTS} && sha256sum * > "crpd_${VERSION}.sha256" && cd -


deployment:
  release:
    branch: new
    tag: /v[0-9]+(\.[0-9]+)*/
    commands:
      - cd ${CIRCLE_ARTIFACTS}; for filename in *; do github-release upload --user "${CIRCLE_PROJECT_USERNAME}" --repo "${CIRCLE_PROJECT_REPONAME}" --tag $CIRCLE_TAG --file ${filename} --name ${filename}; done
